<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Call with Screen Sharing</title>
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a2327, #2a3d4f);
      color: #e0e7f1;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #container {
      display: flex;
      height: calc(100% - 60px);
      transition: all 0.3s ease;
    }

    #video-grid {
      flex: 1;
      display: grid;
      padding: 5px;
      overflow-y: auto;
      background: rgba(26, 35, 39, 0.8);
      border-radius: 10px;
      backdrop-filter: blur(5px);
      transition: flex 0.3s ease;
      gap: 5px;
    }

    .user-panel {
      position: relative;
      background: #1e2a30;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      height: 100%;
    }

    .user-panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .user-panel video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.3s ease;
    }

    .label {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0, 0, 0, 0.6);
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      color: #d1dbe5;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
      transition: opacity 0.3s ease;
    }

    #chat-panel {
      flex: 0;
      background: #1e2a30;
      border-left: 1px solid #3a5063;
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: flex 0.3s ease;
      max-width: 300px;
    }

    #chat-panel.hidden {
      flex: 0;
      max-width: 0;
      padding: 0;
      overflow: hidden;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(30, 42, 48, 0.9);
      border-radius: 8px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chat-message {
      background: #2e3f4a;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      font-size: 14px;
      color: #e0e7f1;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background 0.2s ease;
    }

    .chat-message:hover {
      background: #3a5063;
    }

    #chat-input {
      display: flex;
      gap: 10px;
    }

    #chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #3a5063;
      border-radius: 6px;
      background: #2e3f4a;
      color: #e0e7f1;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    #chat-input input:focus {
      border-color: #4285f4;
      outline: none;
    }

    #chat-input button {
      padding: 10px 15px;
      background: linear-gradient(90deg, #4285f4, #3c9eff);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    #chat-input button:hover {
      background: linear-gradient(90deg, #3c9eff, #4285f4);
      transform: translateY(-2px);
    }

    #controls {
      background: #1e2a30;
      padding: 15px;
      border-top: 1px solid #3a5063;
      display: flex;
      justify-content: center;
      gap: 20px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      transition: background 0.3s ease;
    }

    .control-btn {
      background: linear-gradient(135deg, #2e3f4a, #3a5063);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e0e7f1;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
    }

    .control-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, #3a5063, #2e3f4a);
    }

    #leave-btn {
      background: linear-gradient(135deg, #d93025, #e74c3c);
    }

    #leave-btn:hover {
      background: linear-gradient(135deg, #e74c3c, #d93025);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="video-grid"></div>
    <div id="chat-panel">
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input type="text" id="chat-message" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  <div id="controls">
    <button class="control-btn" onclick="toggleVideo()" title="Toggle Video">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M4 8v8h12l4 4V4l-4 4H4zm2 0h8v2H6V8zm0 4h8v2H6v-2zm0 4h6v2H6v-2z"/>
      </svg>
    </button>
    <button class="control-btn" onclick="toggleAudio()" title="Toggle Audio">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
      </svg>
    </button>
    <button class="control-btn" onclick="shareScreen()" title="Share Screen">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
      </svg>
    </button>
    <button class="control-btn" id="leave-btn" onclick="leaveCall()" title="Leave Call">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 9V5l-7 7 7 7v-4h7V9H10zm2-7v2h9v16h-9v2h11V2H12z"/>
      </svg>
    </button>
    <button class="control-btn" onclick="toggleChat()" title="Toggle Chat">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
    </button>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const videoGrid = document.getElementById('video-grid');
    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    let localStream, screenStream, participantCount = 0;
    const peers = new Map(); // socket_id -> RTCPeerConnection
    const userPanels = new Map(); // socket_id -> { panel, cameraVideo, screenVideo, isSharing, user_id }

    async function startMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      const user_id = prompt('Enter your name:') || 'User';
      const localPanel = createUserPanel(socket.id, user_id);
      const localVideo = document.createElement('video');
      localVideo.id = `camera_${socket.id}`;
      localVideo.autoplay = true;
      localVideo.muted = true;
      localVideo.setAttribute('playsinline', '');
      localPanel.appendChild(localVideo);
      localVideo.srcObject = localStream;
      userPanels.set(socket.id, { panel: localPanel, cameraVideo: localVideo, screenVideo: null, isSharing: false, user_id });
      participantCount++;
      updateGridLayout();
      const session_id = prompt('Enter session_id:') || 'default';
      socket.emit('join', { user_id, session_id });
    }

    function updateGridLayout() {
      const totalPanels = participantCount;
      const columns = Math.min(totalPanels, 2);
      const rows = Math.ceil(totalPanels / 2);
      videoGrid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
      videoGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      document.querySelectorAll('.user-panel').forEach(panel => {
        panel.style.width = '100%';
        panel.style.height = '100%';
      });
    }

    function createUserPanel(socket_id, user_id) {
      const panel = document.createElement('div');
      panel.className = 'user-panel';
      panel.id = `panel_${socket_id}`;
      const nameLabel = document.createElement('div');
      nameLabel.className = 'label';
      nameLabel.textContent = user_id;
      panel.appendChild(nameLabel);
      videoGrid.appendChild(panel);
      return panel;
    }

    function createScreenPanel(socket_id, user_id) {
      const screenPanelId = `screen_${socket_id}`;
      if (document.getElementById(screenPanelId)) return null;
      const panel = document.createElement('div');
      panel.className = 'user-panel';
      panel.id = screenPanelId;
      const screenLabel = document.createElement('div');
      screenLabel.className = 'label';
      screenLabel.textContent = `${user_id}'s Screen`;
      panel.appendChild(screenLabel);
      const screenVideo = document.createElement('video');
      screenVideo.id = `screen_video_${socket_id}`;
      screenVideo.autoplay = true;
      screenVideo.setAttribute('playsinline', '');
      panel.appendChild(screenVideo);
      videoGrid.appendChild(panel);
      return { panel, video: screenVideo };
    }

    function createPeerConnection(socket_id, user_id) {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      console.log(`Adding tracks for ${socket_id}:`, localStream.getTracks());
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      if (screenStream) {
        console.log(`Adding screen stream tracks for ${socket_id}:`, screenStream.getTracks());
        screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));
      }

      pc.ontrack = (event) => {
        console.log(`ontrack event for ${socket_id}:`, event.track.kind, event.streams[0]);
        const stream = event.streams[0];
        const track = event.track;
        let panelData = userPanels.get(socket_id);
        if (!panelData) {
          const panel = createUserPanel(socket_id, user_id);
          panelData = { panel, cameraVideo: null, screenVideo: null, isSharing: false, user_id };
          userPanels.set(socket_id, panelData);
          participantCount++;
          updateGridLayout();
        }

        if (track.kind === 'video') {
          if (!panelData.cameraVideo) {
            panelData.cameraVideo = document.createElement('video');
            panelData.cameraVideo.id = `camera_${socket_id}`;
            panelData.cameraVideo.autoplay = true;
            panelData.cameraVideo.setAttribute('playsinline', '');
            panelData.panel.appendChild(panelData.cameraVideo);
            pc.cameraStream = stream; // Store camera stream in pc
            panelData.cameraVideo.srcObject = stream;
            console.log(`Assigned camera stream to ${socket_id}`);
          } else {
            const peer = peers.get(socket_id);
            if (peer && stream !== peer.cameraStream && !panelData.screenVideo) {
              const screenData = createScreenPanel(socket_id, panelData.user_id);
              if (screenData) {
                panelData.screenVideo = screenData.video;
                panelData.screenVideo.srcObject = stream;
                console.log(`Assigned screen stream to ${socket_id}'s screen panel`);
                panelData.screenVideo.play().catch(err => console.error(`Play error for ${socket_id}:`, err));
                participantCount++;
                updateGridLayout();
              }
            }
          }
        }
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          console.log(`ICE candidate for ${socket_id}:`, event.candidate);
          socket.emit('ice_candidate', { candidate: event.candidate, to: socket_id });
        }
      };

      pc.onnegotiationneeded = async () => {
        console.log(`Negotiation needed for ${socket_id}`);
        try {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit('offer', { offer, to: socket_id });
        } catch (err) {
          console.error(`Negotiation error for ${socket_id}:`, err);
        }
      };

      peers.set(socket_id, pc); // Store pc in peers map
      return pc;
    }

    socket.on('user_joined', async ({ user_id, socket_id }) => {
      if (socket_id === socket.id) return;
      console.log(`User joined: ${user_id}, socket_id: ${socket_id}`);
      const pc = createPeerConnection(socket_id, user_id);
      pc.user_id = user_id;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('offer', { offer, to: socket_id });
    });

    socket.on('offer', async ({ offer, from }) => {
      console.log(`Received offer from ${from}`);
      const pc = createPeerConnection(from, peers.get(from)?.user_id || `User_${from}`);
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', { answer, to: from });
    });

    socket.on('answer', ({ answer, from }) => {
      console.log(`Received answer from ${from}`);
      const pc = peers.get(from);
      pc.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on('ice_candidate', ({ candidate, from }) => {
      console.log(`Received ICE candidate from ${from}`);
      const pc = peers.get(from);
      pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(err => console.error(`ICE error for ${from}:`, err));
    });

    socket.on('user_left', ({ socket_id }) => {
      console.log(`User left: ${socket_id}`);
      const pc = peers.get(socket_id);
      if (pc) {
        pc.close();
        peers.delete(socket_id);
        const panelData = userPanels.get(socket_id);
        if (panelData) {
          panelData.panel.remove();
          if (panelData.screenVideo) {
            const screenPanelId = `screen_${socket_id}`;
            const screenPanel = document.getElementById(screenPanelId);
            if (screenPanel) screenPanel.remove();
            participantCount--;
          }
          userPanels.delete(socket_id);
          participantCount--;
          updateGridLayout();
        }
      }
    });

    socket.on('screen_sharing', ({ socket_id, isSharing, user_id }) => {
      console.log(`Screen sharing update for ${socket_id}: isSharing=${isSharing}, user_id=${user_id}`);
      const panelData = userPanels.get(socket_id);
      if (socket_id === socket.id) {
        if (isSharing && !screenStream) {
          shareScreen(user_id);
        } else if (!isSharing && screenStream) {
          stopScreenShare();
        }
      } else if (panelData) {
        panelData.isSharing = isSharing;
        if (isSharing && !panelData.screenVideo) {
          const pc = peers.get(socket_id); // Retrieve pc from peers map
          if (pc) {
            const screenData = createScreenPanel(socket_id, panelData.user_id);
            if (screenData) {
              panelData.screenVideo = screenData.video;
              // Assign the screen stream from receivers
              pc.getReceivers().forEach(receiver => {
                if (receiver.track.kind === 'video' && (!pc.cameraStream || receiver.track !== pc.cameraStream.getVideoTracks()[0])) {
                  console.log(`Assigning screen stream from receiver for ${socket_id}`);
                  panelData.screenVideo.srcObject = new MediaStream([receiver.track]);
                  panelData.screenVideo.play().catch(err => console.error(`Play error for screen ${socket_id}:`, err));
                }
              });
              participantCount++;
              updateGridLayout();
            }
          }
        } else if (!isSharing && panelData.screenVideo) {
          panelData.screenVideo.remove();
          panelData.screenVideo = null;
          const screenPanelId = `screen_${socket_id}`;
          const screenPanel = document.getElementById(screenPanelId);
          if (screenPanel) screenPanel.remove();
          participantCount--;
          updateGridLayout();
        }
      }
    });

    socket.on('chat_message', ({ user_id, message, timestamp }) => {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message';
      msgDiv.innerHTML = `<strong>${user_id}</strong> (${timestamp}): ${message}`;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    function toggleVideo() {
      const enabled = localStream.getVideoTracks()[0].enabled;
      localStream.getVideoTracks()[0].enabled = !enabled;
    }

    function toggleAudio() {
      const enabled = localStream.getAudioTracks()[0].enabled;
      localStream.getAudioTracks()[0].enabled = !enabled;
    }

    async function shareScreen(user_id) {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        console.log(`Screen stream acquired:`, screenStream.getTracks());
        const screenData = createScreenPanel(socket.id, user_id);
        if (screenData) {
          screenData.video.srcObject = screenStream;
          screenData.video.play().catch(err => console.error(`Local screen play error:`, err));
        }
        socket.emit('screen_sharing', { isSharing: true, user_id });
        participantCount++;
        updateGridLayout();
        screenStream.getVideoTracks()[0].onended = stopScreenShare;
        peers.forEach((pc, peerId) => {
          console.log(`Adding screen track to peer ${peerId}`);
          screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));
        });
        peers.forEach(async (pc, peerId) => {
          if (pc.signalingState !== 'stable') return;
          console.log(`Renegotiating with ${peerId}`);
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit('offer', { offer, to: peerId });
        });
      } catch (err) {
        console.error(`Error sharing screen:`, err);
      }
    }

    function stopScreenShare() {
      if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
        const screenPanelId = `screen_${socket.id}`;
        const screenPanel = document.getElementById(screenPanelId);
        if (screenPanel) screenPanel.remove();
        socket.emit('screen_sharing', { isSharing: false });
        peers.forEach((pc, peerId) => {
          pc.getSenders().forEach(sender => {
            if (sender.track && sender.track.kind === 'video' && !localStream.getVideoTracks().includes(sender.track)) {
              console.log(`Removing screen track from ${peerId}`);
              pc.removeTrack(sender);
            }
          });
        });
        peers.forEach(async (pc, peerId) => {
          if (pc.signalingState !== 'stable') return;
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit('offer', { offer, to: peerId });
        });
        participantCount--;
        updateGridLayout();
      }
    }

    function sendMessage() {
      const message = document.getElementById('chat-message').value.trim();
      if (message) {
        socket.emit('chat_message', { message });
        document.getElementById('chat-message').value = '';
      }
    }

    function toggleChat() {
      chatPanel.classList.toggle('hidden');
      if (!chatPanel.classList.contains('hidden')) {
        videoGrid.style.flex = '3';
      } else {
        videoGrid.style.flex = '1';
      }
    }

    function leaveCall() {
      localStream.getTracks().forEach(track => track.stop());
      if (screenStream) screenStream.getTracks().forEach(track => track.stop());
      peers.forEach(pc => pc.close());
      peers.clear();
      userPanels.forEach(data => data.panel.remove());
      const screenPanelId = `screen_${socket.id}`;
      const screenPanel = document.getElementById(screenPanelId);
      if (screenPanel) screenPanel.remove();
      userPanels.clear();
      socket.disconnect();
      window.location.reload();
    }

    window.onload = startMedia;
  </script>
</body>
</html>